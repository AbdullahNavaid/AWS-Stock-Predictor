<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Predictor</title>
    <!-- Google Font: Lora for elegant serif typography -->
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Universal box-sizing and reset for consistent spacing */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Body styling with serif font and light gray background */
        body {
            font-family: 'Lora', serif;
            background: #f4f4f4;
            padding: 20px;
        }

        /* Adds slightly transparent dollar sign background overlay */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://user-gen-media-assets.s3.amazonaws.com/seedream_images/1094f6e9-3992-4761-8aed-6d2ec1daf0ab.png') no-repeat center center;
            background-size: cover;
            opacity: 0.1; /* lower = more transparent */
            z-index: 0;
        }

        /* Main container: centered, white card with shadow */
        .container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            background: #fff;  /* fully opaque background */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        /* Centered heading with bottom margin */
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        /* Spacing between form elements */
        .form-group {
            margin-bottom: 20px;
        }

        /* Bold labels for form inputs */
        label {
            font-weight: 700;
        }

        /* Full-width text input with padding */
        input[type="text"] {
            width: 100%;
            padding: 10px;
            font-size: 1.1rem;
            margin-top: 5px;
        }

        /* Black button with white text and hover effect */
        button {
            padding: 12px 20px;
            font-size: 1.1rem;
            width: 100%;
            font-weight: 700;
            cursor: pointer;
            background: #000;
            color: #fff;
            border: none;
            transition: 0.3s;
        }

        /* Lighter background on button hover */
        button:hover {
            background: #333;
        }

        /* Centered budget display box with bold text */
        .budget-box {
            text-align: center;
            margin: 20px 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Error message styling: red text on light red background, initially hidden */
        .error {
            color: red;
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
            display: none;
        }

        /* Debug message styling: blue text on light blue background, initially hidden */
        .debug {
            color: blue;
            text-align: left;
            margin: 10px 0;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 0.9rem;
            display: none;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Loading indicator container, initially hidden */
        .loading {
            display: none;
            text-align: center;
            margin: 40px auto;
            font-size: 1.1rem;
            color: #444;
        }

        /* Animated spinner: circular border with rotating animation */
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid transparent;
            border-top: 5px solid #4caf50;
            border-right: 5px solid #2196f3;
            border-radius: 50%;
            margin: 0 auto 15px auto;
            animation: spin 0.9s linear infinite;
        }

        /* Rotation animation for spinner */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Loading text with fade in/out animation */
        .loading-text {
            font-weight: 600;
            color: #222;
            letter-spacing: 0.5px;
            animation: fadeInOut 1.6s ease-in-out infinite;
        }

        /* Fade animation for loading text */
        @keyframes fadeInOut {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Table styling: full width with collapsed borders */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        /* Cell padding and borders for all table cells */
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }

        /* Table headers: black background, white text, clickable with hover effects */
        th {
            background: #000;
            color: #fff;
            cursor: pointer;
            position: relative;
            transition: all 0.25s ease;
        }

        /* Header hover effect: slight lift and shadow */
        th:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            background: #111;
        }

        /* Sort indicator arrows after each header */
        th::after {
            content: "⇅";
            font-size: 0.7rem;
            color: #ccc;
            margin-left: 5px;
            opacity: 0.7;
        }

        /* Zebra striping for table rows */
        tr:nth-child(even) {
            background: #f9f9f9;
        }

        /* Back link container at top of page */
        .back-link {
            text-align: center;
            margin-bottom: 20px;
        }

        /* Back link styling: black text, bold, underline on hover */
        .back-link a {
            color: #000;
            text-decoration: none;
            font-weight: 700;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        /* Green text and bold for high price column */
        th.high, td.high {
            color: green;
            font-weight: bold;
        }

        /* Red text and bold for low price column */
        th.low, td.low {
            color: red;
            font-weight: bold;
        }

        /* Bold text for gain/loss column header and cells */
        th.gainloss, td.gainloss {
            font-weight: bold;
        }

        /* Green text and bold for positive gains */
        td.gain {
            color: green;
            font-weight: 700;
        }

        /* Red text and bold for losses */
        td.loss {
            color: red;
            font-weight: 700;
        }

        /* Gray text for zero change */
        td.zero {
            color: #666;
        }

        /* Up arrow indicator for gains */
        td.gain::after {
            content: ' ▲';
            font-size: 0.8rem;
            vertical-align: middle;
        }

        /* Down arrow indicator for losses */
        td.loss::after {
            content: ' ▼';
            font-size: 0.8rem;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation link to return to budget entry page -->
        <div class="back-link">
            <a href="start.html">← Change Budget</a>
        </div>

        <h1>Stock Tracker</h1>

        <!-- Budget display area, populated by JavaScript -->
        <div id="budgetDisplay" class="budget-box"></div>
        
        <!-- Error message container, shown/hidden dynamically -->
        <div id="errorMsg" class="error"></div>
        
        <!-- Debug message container for development purposes -->
        <div id="debugMsg" class="debug"></div>

        <!-- Form for entering stock ticker symbol -->
        <form id="predictionForm">
            <div class="form-group">
                <label for="ticker">Enter Stock Ticker:</label>
                <input type="text" id="ticker" placeholder="e.g., AAPL">
            </div>
            <button type="submit">Search Ticker</button>
        </form>

        <!-- Loading indicator with spinner, shown during API fetch -->
        <div class="loading" id="stocksLoading">
            <div class="spinner"></div>
            <div class="loading-text">Loading market data...</div>
        </div>

        <!-- Stock data table, initially hidden until data loads -->
        <table id="stocksTable" style="display:none;">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Date</th>
                    <th class="gainloss">Daily Gain/Loss</th>
                    <th class="high">High</th>
                    <th class="low">Low</th>
                    <th>Volume</th>
                </tr>
            </thead>
            <tbody id="stocksTableBody"></tbody>
        </table>
    </div>

    <script>
        // API endpoint for fetching stock data
        const API_URL = 'https://a3gp55veoh.execute-api.us-east-1.amazonaws.com/prod/stocks';
        
        // Global array to store all stock data from API
        let allStocks = [];
        
        // User's investment budget
        let budget = 0;

        /**
         * Retrieves budget from URL query parameter and displays it.
         * Redirects to start page if budget is not provided.
         */
        function getBudgetFromURL() {
            const params = new URLSearchParams(window.location.search);
            const budgetParam = params.get('budget');
            
            if (budgetParam) {
                // Parse budget and display with proper formatting
                budget = parseFloat(budgetParam);
                document.getElementById('budgetDisplay').textContent = 
                    `Budget: $${budget.toLocaleString('en-US', { 
                        minimumFractionDigits: 0, 
                        maximumFractionDigits: 0 
                    })}`;
            } else {
                // No budget provided, redirect to start page
                window.location.href = 'start.html';
            }
        }

        /**
         * Displays an error message to the user.
         * @param {string} message - The error message to display
         */
        function showError(message) {
            const errorEl = document.getElementById('errorMsg');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        /**
         * Hides the error message container.
         */
        function hideError() {
            document.getElementById('errorMsg').style.display = 'none';
        }

        /**
         * Fetches stock data from API and populates the table.
         * Shows loading spinner during fetch and handles errors.
         */
        async function loadStocks() {
            const loading = document.getElementById('stocksLoading');
            const table = document.getElementById('stocksTable');
            const tbody = document.getElementById('stocksTableBody');

            // Show loading indicator, hide table and errors
            loading.style.display = 'block';
            table.style.display = 'none';
            hideError();

            try {
                // Fetch stock data from API
                const response = await fetch(API_URL);
                const result = await response.json();
                
                // Store stocks array from response
                allStocks = result.stocks || [];

                if (allStocks.length === 0) {
                    showError('No stock data received from API');
                } else {
                    // Display stocks in table and enable sorting
                    displayStocks(allStocks);
                    makeTableSortable('stocksTable');
                }
            } catch (err) {
                // Handle fetch or parsing errors
                showError('Failed to load stocks. Please try again later.');
                console.error('Full error:', err);
            } finally {
                // Hide loading indicator regardless of success/failure
                loading.style.display = 'none';
            }
        }

        /**
         * Populates the stock table with data from stocks array.
         * Only displays stocks with complete history data.
         * @param {Array} stocks - Array of stock objects to display
         */
        function displayStocks(stocks) {
            const table = document.getElementById('stocksTable');
            const tbody = document.getElementById('stocksTableBody');
            
            // Clear existing table rows
            tbody.innerHTML = '';

            stocks.forEach(s => {
                // Skip stocks without history data
                if (!s.history || !s.history.length) return;

                // Get most recent day's data
                const latest = s.history[s.history.length - 1];
                
                // Skip if missing required price data
                if (!latest.open || !latest.close || !latest.high || !latest.low) return;

                // Calculate daily gain/loss (close - open)
                const gainLoss = latest.close - latest.open;
                
                // Determine CSS class based on gain/loss/zero
                const gainLossClass = gainLoss > 0 ? 'gain' : gainLoss < 0 ? 'loss' : 'zero';

                // Create and populate table row
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${s.ticker}</td>
                    <td>${latest.date || 'N/A'}</td>
                    <td class="gainloss ${gainLossClass}">$${gainLoss.toFixed(2)}</td>
                    <td class="high">$${latest.high.toFixed(2)}</td>
                    <td class="low">$${latest.low.toFixed(2)}</td>
                    <td>${latest.volume.toLocaleString()}</td>
                `;
            });

            // Show table only if rows were added, otherwise show error
            table.style.display = tbody.rows.length ? 'table' : 'none';
            if (!tbody.rows.length) showError('No valid stock data available to display');
        }

        /**
         * Makes table columns sortable by clicking headers.
         * Handles numeric, date, and text sorting with toggle between ascending/descending.
         * @param {string} tableId - ID of the table element to make sortable
         */
        function makeTableSortable(tableId) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('th');
            
            // Track sort direction for each column (1 = ascending, -1 = descending)
            const sortOrder = {};

            headers.forEach((header, index) => {
                // Initialize sort order to ascending
                sortOrder[index] = 1;

                // Add click listener to each header
                header.addEventListener('click', () => {
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));

                    // Sort rows based on column data type
                    rows.sort((a, b) => {
                        let aText = a.cells[index].textContent.trim();
                        let bText = b.cells[index].textContent.trim();

                        // Numeric columns: remove currency/comma formatting and parse as float
                        if (['Daily Gain/Loss', 'High', 'Low', 'Volume'].includes(header.textContent)) {
                            aText = parseFloat(aText.replace(/[$,]/g, '')) || 0;
                            bText = parseFloat(bText.replace(/[$,]/g, '')) || 0;
                        } 
                        // Date column: parse as Date object
                        else if (header.textContent === 'Date') {
                            aText = new Date(aText);
                            bText = new Date(bText);
                        } 
                        // Text columns: convert to uppercase for case-insensitive comparison
                        else {
                            aText = aText.toUpperCase();
                            bText = bText.toUpperCase();
                        }

                        // Compare values and apply sort direction
                        if (aText < bText) return -1 * sortOrder[index];
                        if (aText > bText) return 1 * sortOrder[index];
                        return 0;
                    });

                    // Re-append rows in sorted order
                    rows.forEach(row => tbody.appendChild(row));

                    // Toggle sort direction for next click
                    sortOrder[index] *= -1;
                });
            });
        }

        /**
         * Handles form submission to search for a specific ticker.
         * Validates ticker exists in loaded stocks before navigating to results page.
         */
        document.getElementById('predictionForm').addEventListener('submit', e => {
            e.preventDefault();

            const tickerInput = document.getElementById('ticker');
            const ticker = tickerInput.value.trim().toUpperCase();

            // Don't proceed if input is empty
            if (!ticker) return;

            // Check if entered ticker exists in our stock list
            const isListed = allStocks.some(s => s.ticker.toUpperCase() === ticker);

            if (!isListed) {
                // Show error if ticker not found
                showError(`"${ticker}" is not on the stock list.`);
                tickerInput.focus();
                return;
            }

            // Valid ticker: navigate to results page with ticker and budget parameters
            hideError();
            window.location.href = `results.html?ticker=${encodeURIComponent(ticker)}&budget=${encodeURIComponent(budget)}`;
        });

        // Initialize page: get budget from URL and load stock data
        getBudgetFromURL();
        loadStocks();
    </script>
</body>
</html>